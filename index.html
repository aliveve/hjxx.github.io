<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幻境修仙 - 终极修复版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", sans-serif;
        }
        body {
            background: url("https://picsum.photos/id/1039/1920/1080") no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            overflow-x: hidden;
        }
        #game-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(139, 69, 19, 0.5);
        }
        #status-bar {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(160, 82, 45, 0.6);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .panel {
            display: none;
            padding: 20px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.7);
            margin-bottom: 20px;
            min-height: 400px;
        }
        .active {
            display: block !important;
        }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #cd853f;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #d2691e;
            transform: scale(1.05);
        }
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        #map-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .map-card {
            padding: 15px;
            background: rgba(210, 105, 30, 0.4);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .map-card:hover {
            background: rgba(210, 105, 30, 0.7);
        }
        #search-result, #battle-log, #friend-list, #sect-list {
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            min-height: 100px;
        }
        #backpack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .item-card {
            padding: 10px;
            background: rgba(139, 69, 19, 0.5);
            border-radius: 5px;
            text-align: center;
        }
        #shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .shop-item {
            padding: 10px;
            background: rgba(205, 133, 63, 0.5);
            border-radius: 5px;
            text-align: center;
        }
        #battle-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
        }
        .role-card {
            padding: 20px;
            background: rgba(178, 34, 34, 0.5);
            border-radius: 10px;
            text-align: center;
        }
        #skill-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .skill-btn {
            padding: 10px;
            background: rgba(70, 130, 180, 0.7);
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
        }
        .skill-btn:disabled {
            background: #555;
        }
        #sect-mission {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 215, 0, 0.3);
            border-radius: 5px;
        }
        #cultivate-btn-1, #cultivate-btn-2 {
            font-size: 18px;
            padding: 15px 30px;
            margin: 10px;
        }
        #friend-interact {
            margin: 15px 0;
            padding: 10px;
        }
        .save-btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .nav-lock {
            pointer-events: none;
            opacity: 0.5;
        }
        /* 双修提示动画样式 */
        .double-cultivate-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(210, 105, 30, 0.95);
            padding: 40px 60px;
            border-radius: 15px;
            font-size: 24px;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: fadeInOut 3s ease-in-out;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            20% { opacity: 1; transform: translate(-50%, -50%); }
            70% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="save-btn-group">
            <button class="btn" onclick="saveGame()">存档</button>
            <button class="btn" onclick="loadGame()">读档</button>
            <button class="btn" onclick="clearSave()">清除存档</button>
        </div>
        <div id="status-bar">
            <div>境界: <span id="realm">1阶1层</span></div>
            <div>修为: <span id="cultivation">0</span></div>
            <div>货币: <span id="money">0</span> 灵石</div>
            <div>背包容量: <span id="backpack-capacity">20</span>/<span id="backpack-max">20</span></div>
            <div>当前护盾: <span id="shield-value">0</span></div> <!-- 显示护盾值 -->
        </div>
        <div id="nav-buttons">
            <button class="btn" onclick="switchPanel('cultivate-panel')">修炼</button>
            <button class="btn" onclick="switchPanel('backpack-panel')">背包</button>
            <button class="btn" onclick="switchPanel('map-panel')">地图</button>
            <button class="btn" onclick="switchPanel('shop-panel')">商店</button>
            <button class="btn" onclick="switchPanel('sect-panel')">宗门</button>
            <button class="btn" onclick="switchPanel('friend-panel')">道友</button>
            <button class="btn" onclick="switchPanel('status-panel')">状态</button>
        </div>
        <!-- 新增：修炼面板添加灵石换修为按钮 -->
        <div id="cultivate-panel" class="panel active">
            <button id="cultivate-btn-1" class="btn" onclick="cultivateType1()">消耗灵力修炼 (30-90修为)</button>
            <button id="cultivate-btn-2" class="btn" onclick="cultivateType2()">战斗突破 (境界越高收益越高)</button>
            <button class="btn" onclick="exchangeSpiritStoneForCultivation()">灵石兑换修为 (消耗20灵石，随机1-10修为)</button>
            <div id="cultivate-log" style="margin-top:20px;padding:10px;background:rgba(0,0,0,0.5);border-radius:5px;"></div>
        </div>
        <div id="backpack-panel" class="panel">
            <button class="btn" onclick="upgradeBackpack()">升级背包 (100灵石/级)</button>
            <div id="backpack-grid"></div>
        </div>
        <div id="map-panel" class="panel">
            <div id="map-container">
                <div class="map-card" onclick="enterMap('落皇坊')">落皇坊<br><small>低级地图 | 妖兽/道友 1-2阶</small></div>
                <div class="map-card" onclick="enterMap('黄玲盅')">黄玲盅<br><small>低级地图 | 妖兽/道友 1-3阶</small></div>
                <div class="map-card" onclick="enterMap('悬银幕')">悬银幕<br><small>中级地图 | 妖兽/道友 3-5阶</small></div>
                <div class="map-card" onclick="enterMap('森地医')">森地医<br><small>高级地图 | 妖兽/道友 5-8阶</small></div>
                <div class="map-card" onclick="enterMap('根渊')">根渊<br><small>顶级地图 | 妖兽/道友 8-10阶</small></div>
            </div>
            <div id="current-map" style="margin-top:20px;"></div>
            <button class="btn" id="search-btn" onclick="search()" disabled>搜索物资</button>
            <div id="search-result"></div>
        </div>
        <div id="shop-panel" class="panel">
            <h3>出售物资</h3>
            <div id="sell-grid"></div>
            <h3>购买功法</h3>
            <div id="shop-grid"></div>
        </div>
        <div id="sect-panel" class="panel">
            <div id="sect-list">
                <div class="btn" onclick="joinSect('青云宗')">青云宗</div>
                <div class="btn" onclick="joinSect('丹霞谷')">丹霞谷</div>
                <div class="btn" onclick="joinSect('幽冥殿')">幽冥殿</div>
                <div class="btn" onclick="joinSect('百草堂')">百草堂</div>
                <div class="btn" onclick="joinSect('天机阁')">天机阁</div>
                <div class="btn" onclick="joinSect('万兽门')">万兽门</div>
                <div class="btn" onclick="joinSect('御剑宗')">御剑宗</div>
            </div>
            <div id="current-sect" style="margin-top:20px;"></div>
            <button class="btn" id="create-sect-btn" onclick="createSect()" disabled>创建宗门</button>
            <div id="sect-mission"></div>
            <button class="btn" id="quit-sect-btn" onclick="quitSect()" disabled>退出宗门</button>
        </div>
        <div id="friend-panel" class="panel">
            <div id="friend-list"></div>
            <div id="friend-interact"></div>
            <!-- 新增：结识道友按钮 -->
            <button class="btn" onclick="meetFriend()">结识道友 (消耗50灵石)</button>
            <button class="btn" id="double-cultivate-btn" onclick="cultivateDouble()" style="margin-top:15px;">与道友双修</button>
        </div>
        <div id="status-panel" class="panel">
            <div>当前境界: <span id="status-realm">1阶1层</span></div>
            <div>总修为: <span id="status-cultivation">0</span></div>
            <div>持有灵石: <span id="status-money">0</span></div>
            <div>已学功法: <span id="status-skills">0</span></div>
            <div>当前宗门: <span id="status-sect">无</span></div>
            <div>结交道友: <span id="status-friends">0</span></div>
            <div>当前护盾: <span id="status-shield">0</span></div> <!-- 状态面板显示护盾 -->
        </div>
        <div id="battle-panel" class="panel">
            <div id="battle-container">
                <div class="role-card">
                    <h3>玩家</h3>
                    <div>境界: <span id="player-realm">1阶1层</span></div>
                    <div>血量: <span id="player-hp">100</span>/<span id="player-maxhp">100</span></div>
                    <div>护盾: <span id="player-shield">0</span></div> <!-- 战斗面板显示护盾 -->
                </div>
                <div class="role-card">
                    <h3><span id="enemy-type">妖兽</span></h3>
                    <div>境界: <span id="enemy-realm">1阶1层</span></div>
                    <div>血量: <span id="enemy-hp">100</span>/<span id="enemy-maxhp">100</span></div>
                </div>
            </div>
            <div id="skill-container"></div>
            <div id="battle-log"></div>
            <button class="btn" id="escape-btn" onclick="escapeBattle()" disabled>逃跑</button>
        </div>
    </div>
    <script>
        // ========== 全局常量 & 变量声明（修复核心：补全所有缺失声明） ==========
        const BASE_HP = 100;
        const HP_PER_REALM = 50;
        const BUFF_DURATION = 3;
        const SAVE_KEY = "huanjingxiuxian_save_v1";
        let currentMap = ""; // 修复：声明当前地图全局变量
        let inBattle = false;
        let playerTurn = true;
        let currentEnemy = { type: "", realm: { big: 0, small: 0 }, hp: 0, maxHp: 0, skill: {} };
        // 玩家数据
        let playerData = {
            realm: { big: 1, small: 1 },
            cultivation: 0,
            money: 0,
            backpack: [],
            backpackMax: 20,
            skills: [],
            sect: "",
            friends: [],
            hp: BASE_HP,
            lastDoubleTime: 0,
            attackBuff: 0,
            defenseBuff: 0,
            speedBuff: 0,
            isVampire: false,
            buffRound: 0
        };
        // 配置表
        const maps = {
            "落皇坊": { level: 1, materials: ["下品灵石", "止血草", "凡铁", "一阶妖兽内丹"], enemyLevel: [1,2] },
            "黄玲盅": { level: 1, materials: ["下品灵石", "解毒丹", "桃木剑", "一阶妖兽内丹"], enemyLevel: [1,3] },
            "悬银幕": { level: 2, materials: ["中品灵石", "聚气丹", "二阶妖兽内丹", "破甲符"], enemyLevel: [3,5] },
            "森地医": { level: 3, materials: ["上品灵石", "疗伤丹", "三阶妖兽内丹", "隐身符"], enemyLevel: [5,8] },
            "根渊": { level: 4, materials: ["极品灵石", "洗髓丹", "五阶妖兽内丹", "传送符"], enemyLevel: [8,10] }
        };
        const materials = [
            "下品灵石", "中品灵石", "上品灵石", "极品灵石", "止血草", "解毒草", "聚气草", "洗髓草",
            "凡铁", "精铁", "玄铁", "陨铁", "桃木剑", "铁剑", "铜剑", "玄铁剑", "一阶妖兽内丹", "二阶妖兽内丹",
            "三阶妖兽内丹", "四阶妖兽内丹", "五阶妖兽内丹", "六阶妖兽内丹", "七阶妖兽内丹", "八阶妖兽内丹",
            "九阶妖兽内丹", "十阶妖兽内丹", "止血丹", "解毒丹", "聚气丹", "疗伤丹", "洗髓丹", "破障丹",
            "破甲符", "隐身符", "传送符", "攻击符", "防御符", "飞行符", "一阶功法残卷", "二阶功法残卷",
            "三阶功法残卷", "四阶功法残卷", "五阶功法残卷", "宗门令牌", "道友信物", "双修丹", "悟道茶",
            "灵酒", "妖兽肉", "灵米", "阵法盘", "炼器炉", "炼丹炉", "符箓纸", "朱砂"
        ];
        const itemValueMap = {
            "下品灵石": 10, "中品灵石": 50, "上品灵石": 200, "极品灵石": 1000,
            "止血草": 8, "解毒草": 15, "聚气草": 30, "洗髓草": 100,
            "凡铁": 5, "精铁": 25, "玄铁": 80, "陨铁": 300,
            "桃木剑": 20, "铁剑": 50, "铜剑": 100, "玄铁剑": 300,
            "一阶妖兽内丹": 50, "二阶妖兽内丹": 150, "三阶妖兽内丹": 400, "四阶妖兽内丹": 1000,
            "五阶妖兽内丹": 2500, "六阶妖兽内丹": 5000, "七阶妖兽内丹": 10000, "八阶妖兽内丹": 20000,
            "九阶妖兽内丹": 50000, "十阶妖兽内丹": 100000,
            "止血丹": 20, "解毒丹": 40, "聚气丹": 100, "疗伤丹": 200, "洗髓丹": 500, "破障丹": 1000,
            "破甲符": 30, "隐身符": 100, "传送符": 500, "攻击符": 80, "防御符": 80, "飞行符": 200,
            "一阶功法残卷": 200, "二阶功法残卷": 500, "三阶功法残卷": 1500, "四阶功法残卷": 5000, "五阶功法残卷": 15000,
            "宗门令牌": 1000, "道友信物": 800, "双修丹": 500, "悟道茶": 300, "灵酒": 150,
            "妖兽肉": 20, "灵米": 15, "阵法盘": 2000, "炼器炉": 3000, "炼丹炉": 3000, "符箓纸": 10, "朱砂": 15
        };
        const skills = [
            { name: "普攻", level: 0, type: "attack", power: 10, desc: "基础攻击" },
            { name: "烈火掌", level: 1, type: "attack", power: 20, desc: "一阶攻击功法" },
            { name: "寒冰指", level: 1, type: "attack", power: 22, desc: "一阶攻击功法" },
            { name: "雷电术", level: 2, type: "attack", power: 35, desc: "二阶攻击功法" },
            { name: "旋风斩", level: 2, type: "attack", power: 38, desc: "二阶攻击功法" },
            { name: "龙炎破", level: 3, type: "attack", power: 50, desc: "三阶攻击功法" },
            { name: "冰天雪地", level: 3, type: "attack", power: 55, desc: "三阶攻击功法" },
            { name: "雷动九天", level: 4, type: "attack", power: 70, desc: "四阶攻击功法" },
            { name: "狂风绝息", level: 4, type: "attack", power: 75, desc: "四阶攻击功法" },
            { name: "焚天灭地", level: 5, type: "attack", power: 100, desc: "五阶攻击功法" },
            { name: "冰封万里", level: 5, type: "attack", power: 105, desc: "五阶攻击功法" },
            { name: "金钟罩", level: 1, type: "defense", power: 15, desc: "一阶防御功法" },
            { name: "铁布衫", level: 1, type: "defense", power: 18, desc: "一阶防御功法" },
            { name: "玄武盾", level: 2, type: "defense", power: 30, desc: "二阶防御功法" },
            { name: "金刚不坏", level: 2, type: "defense", power: 33, desc: "二阶防御功法" },
            { name: "龙鳞甲", level: 3, type: "defense", power: 45, desc: "三阶防御功法" },
            { name: "凤羽衣", level: 3, type: "defense", power: 48, desc: "三阶防御功法" },
            { name: "鸿蒙盾", level: 4, type: "defense", power: 60, desc: "四阶防御功法" },
            { name: "混沌衣", level: 4, type: "defense", power: 65, desc: "四阶防御功法" },
            { name: "乾坤罩", level: 5, type: "defense", power: 85, desc: "五阶防御功法" },
            { name: "天地衣", level: 5, type: "defense", power: 90, desc: "五阶防御功法" },
            { name: "聚气术", level: 1, type: "buff", power: 5, desc: "提升5点攻击" },
            { name: "强身术", level: 1, type: "buff", power: 5, desc: "提升5点防御" },
            { name: "狂暴术", level: 2, type: "buff", power: 10, desc: "提升10点攻击" },
            { name: "护体术", level: 2, type: "buff", power: 10, desc: "提升10点防御" },
            { name: "战神附体", level: 3, type: "buff", power: 20, desc: "提升20点攻击" },
            { name: "金刚护体", level: 3, type: "buff", power: 20, desc: "提升20点防御" },
            { name: "仙法附体", level: 4, type: "buff", power: 30, desc: "提升30点攻击" },
            { name: "神盾护体", level: 4, type: "buff", power: 30, desc: "提升30点防御" },
            { name: "天道加持", level: 5, type: "buff", power: 50, desc: "提升50点攻击防御" },
            { name: "清心诀", level: 1, type: "heal", power: 20, desc: "一阶回血功法，恢复20点血" },
            { name: "回春术", level: 3, type: "heal", power: 50, desc: "三阶回血功法，恢复50点血" },
            { name: "九转还魂", level: 5, type: "heal", power: 120, desc: "五阶回血功法，恢复120点血" },
            { name: "破空拳", level: 1, type: "attack", power: 25, desc: "一阶攻击功法，拳风破甲" },
            { name: "月影剑", level: 2, type: "attack", power: 42, desc: "二阶攻击功法，剑如月影" },
            { name: "焚山焰", level: 3, type: "attack", power: 60, desc: "三阶攻击功法，烈焰焚山" },
            { name: "寒霜刺", level: 4, type: "attack", power: 80, desc: "四阶攻击功法，寒芒刺骨" },
            { name: "万剑归宗", level: 5, type: "attack", power: 110, desc: "五阶攻击功法，万剑齐发" },
            { name: "碎星掌", level: 5, type: "attack", power: 115, desc: "五阶攻击功法，掌碎星辰" },
            { name: "幽冥爪", level: 4, type: "attack", power: 78, desc: "四阶攻击功法，幽冥噬魂" },
            { name: "磐石诀", level: 2, type: "defense", power: 35, desc: "二阶防御功法，坚如磐石" },
            { name: "琉璃身", level: 4, type: "defense", power: 68, desc: "四阶防御功法，琉璃护体" },
            { name: "不灭金身", level: 5, type: "defense", power: 95, desc: "五阶防御功法，金身不灭" },
            { name: "疾风步", level: 2, type: "speed", power: 15, desc: "二阶buff功法，提升15点速度，优先攻击" },
            { name: "噬灵咒", level: 4, type: "vampire", power: 25, desc: "四阶buff功法，攻击吸血25%" }
        ];
        const sects = ["青云宗", "丹霞谷", "幽冥殿", "百草堂", "天机阁", "万兽门", "御剑宗"];
        const friends = [
            { name: "李逍遥", gender: "男", realm: { big: 2, small: 5 }, desc: "潇洒不羁的剑修" },
            { name: "赵灵儿", gender: "女", realm: { big: 3, small: 2 }, desc: "温柔善良的灵修" },
            { name: "林月如", gender: "女", realm: { big: 2, small: 8 }, desc: "英姿飒爽的武修" },
            { name: "景天", gender: "男", realm: { big: 4, small: 1 }, desc: "贪财的炼器师" },
            { name: "雪见", gender: "女", realm: { big: 3, small: 7 }, desc: "活泼可爱的丹修" },
            { name: "徐长卿", gender: "男", realm: { big: 5, small: 3 }, desc: "严谨的道修" },
            { name: "紫萱", gender: "女", realm: { big: 5, small: 9 }, desc: "神秘的蛊修" }
        ];
        // ========== 工具函数 ==========
        function getMaxHp(realmBig) {
            return BASE_HP + realmBig * HP_PER_REALM;
        }
        function updateStatus() {
            document.getElementById('realm').innerText = `${playerData.realm.big}阶${playerData.realm.small}层`;
            document.getElementById('cultivation').innerText = playerData.cultivation;
            document.getElementById('money').innerText = playerData.money;
            document.getElementById('backpack-capacity').innerText = playerData.backpack.length;
            document.getElementById('backpack-max').innerText = playerData.backpackMax;
            document.getElementById('shield-value').innerText = playerData.defenseBuff; // 更新顶部状态栏护盾
        }
        function updateStatusPanel() {
            document.getElementById('status-realm').innerText = `${playerData.realm.big}阶${playerData.realm.small}层`;
            document.getElementById('status-cultivation').innerText = playerData.cultivation;
            document.getElementById('status-money').innerText = playerData.money;
            document.getElementById('status-skills').innerText = playerData.skills.length;
            document.getElementById('status-sect').innerText = playerData.sect || "无";
            document.getElementById('status-friends').innerText = playerData.friends.length;
            document.getElementById('status-shield').innerText = playerData.defenseBuff; // 更新状态面板护盾
        }
        function updateBackpack() {
            const backpackGrid = document.getElementById('backpack-grid');
            backpackGrid.innerHTML = "";
            playerData.backpack.forEach((item, index) => {
                const itemCard = document.createElement('div');
                itemCard.className = "item-card";
                itemCard.innerHTML = `${item}<br><button class="btn" onclick="sellItem(${index})">出售</button>`;
                backpackGrid.appendChild(itemCard);
            });
            updateSellGrid();
            // 修复3：同步更新背包容量显示
            document.getElementById('backpack-capacity').innerText = playerData.backpack.length;
            document.getElementById('backpack-max').innerText = playerData.backpackMax;
        }
        function updateSellGrid() {
            const sellGrid = document.getElementById('sell-grid');
            sellGrid.innerHTML = "";
            playerData.backpack.forEach((item, index) => {
                const price = itemValueMap[item] || 10;
                const sellItem = document.createElement('div');
                sellItem.className = "shop-item";
                sellItem.innerHTML = `${item}<br>售价: ${price} 灵石<br><button class="btn" onclick="sellItem(${index})">出售</button>`;
                sellGrid.appendChild(sellItem);
            });
        }
        function updateShop() {
            const shopGrid = document.getElementById('shop-grid');
            shopGrid.innerHTML = "";
            skills.filter(skill => skill.level > 0).forEach(skill => {
                const price = skill.level * 50;
                // 修复2：删除境界限制，移除requireRealm相关判断
                const shopItem = document.createElement('div');
                shopItem.className = "shop-item";
                shopItem.innerHTML = `
                    ${skill.name} (${skill.level}阶)<br>
                    ${skill.desc}<br>
                    价格: ${price} 灵石<br>
                    <button class="btn" onclick="buySkill('${skill.name}')">购买</button>
                `;
                shopGrid.appendChild(shopItem);
            });
        }
        function updateFriendList() {
            const friendList = document.getElementById('friend-list');
            friendList.innerHTML = "";
            if(playerData.friends.length === 0) {
                friendList.innerText = "暂无道友，点击下方按钮结识！";
                return;
            }
            playerData.friends.forEach(friend => {
                const friendCard = document.createElement('div');
                friendCard.innerHTML = `${friend.name} - ${friend.realm.big}阶${friend.realm.small}层<br>${friend.desc}<br>`;
                friendList.appendChild(friendCard);
            });
        }
        function updateSkills() {
            const skillContainer = document.getElementById('skill-container');
            skillContainer.innerHTML = "";
            playerData.skills.forEach((skill, index) => {
                const btn = document.createElement('button');
                btn.className = "skill-btn";
                btn.innerText = skill.name;
                btn.disabled = !playerTurn; // 仅在玩家回合启用技能
                btn.onclick = () => useSkill(index);
                skillContainer.appendChild(btn);
            });
        }
        // 新增：更新战斗面板护盾显示
        function updateBattleShield() {
            document.getElementById('player-shield').innerText = playerData.defenseBuff;
        }
        // ========== 核心功能函数 ==========
        function saveGame() {
            try {
                localStorage.setItem(SAVE_KEY, JSON.stringify(playerData));
                alert("存档成功！");
            } catch (e) {
                alert("存档失败：" + e.message);
            }
        }
        function loadGame(silent = false) {
            try {
                const saveData = localStorage.getItem(SAVE_KEY);
                if(!saveData) {
                    if(!silent) alert("暂无存档，使用新数据！");
                    return;
                }
                playerData = JSON.parse(saveData);
                if(!silent) alert("读档成功！");
                updateStatus();
                updateBackpack();
                updateShop();
                updateFriendList();
                updateStatusPanel();
                updateBattleShield(); // 加载时更新护盾显示
            } catch (e) {
                alert("读档失败：存档损坏！");
            }
        }
        function clearSave() {
            if(confirm("确定清除存档？")) {
                localStorage.removeItem(SAVE_KEY);
                playerData = {
                    realm: { big: 1, small: 1 },
                    cultivation: 0,
                    money: 0,
                    backpack: [],
                    backpackMax: 20,
                    skills: [skills[0]],
                    sect: "",
                    friends: [],
                    hp: BASE_HP,
                    lastDoubleTime: 0,
                    attackBuff: 0,
                    defenseBuff: 0,
                    speedBuff: 0,
                    isVampire: false,
                    buffRound: 0
                };
                alert("存档已清除！");
                updateStatus();
                updateBackpack();
                updateShop();
                updateFriendList();
                updateStatusPanel();
                updateBattleShield(); // 清除存档后更新护盾
            }
        }
        function switchPanel(panelId) {
            if(inBattle && panelId !== 'battle-panel') return;
            document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
            if(panelId === 'status-panel') updateStatusPanel();
        }
        function cultivateType1() {
            if(playerData.cultivation < 50) {
                document.getElementById('cultivate-log').innerText = "修为不足50！";
                return;
            }
            playerData.cultivation -= 50;
            const add = Math.floor(Math.random() * 61) + 30;
            playerData.cultivation += add;
            document.getElementById('cultivate-log').innerText = `消耗50修为，获得${add}修为！当前: ${playerData.cultivation}`;
            checkRealmUp();
            updateStatus();
            updateStatusPanel();
        }
        function cultivateType2() {
            if(inBattle) {
                document.getElementById('cultivate-log').innerText = "战斗中无法突破！";
                return;
            }
            document.getElementById('cultivate-log').innerText = "前往地图触发战斗突破！";
            switchPanel('map-panel');
        }
        // 新增：灵石兑换修为函数
        function exchangeSpiritStoneForCultivation() {
            const cost = 20; // 消耗20灵石
            if(playerData.money < cost) {
                document.getElementById('cultivate-log').innerText = "灵石不足20，无法兑换！";
                return;
            }
            const addCult = Math.floor(Math.random() * 10) + 1; // 随机1-10修为
            playerData.money -= cost;
            playerData.cultivation += addCult;
            document.getElementById('cultivate-log').innerText = `消耗${cost}灵石，兑换获得${addCult}点修为！当前修为: ${playerData.cultivation}，剩余灵石: ${playerData.money}`;
            checkRealmUp();
            updateStatus();
            updateStatusPanel();
        }
        function checkRealmUp() {
            const need = playerData.realm.big * 100;
            while(playerData.cultivation >= need) {
                playerData.cultivation -= need;
                playerData.realm.small += 1;
                if(playerData.realm.small > 10) {
                    playerData.realm.small = 1;
                    playerData.realm.big += 1;
                    playerData.hp += HP_PER_REALM;
                }
            }
            document.getElementById('cultivate-log').innerText += `\n当前境界: ${playerData.realm.big}阶${playerData.realm.small}层`;
        }
        function enterMap(mapName) {
            currentMap = mapName;
            document.getElementById('current-map').innerText = `当前地图: ${mapName} | 推荐境界: ${maps[mapName].enemyLevel[0]}-${maps[mapName].enemyLevel[1]}阶`;
            document.getElementById('search-btn').disabled = false;
            document.getElementById('search-result').innerText = "";
        }
        function search() {
            if(inBattle) return;
            const mapInfo = maps[currentMap];
            const randomItem = mapInfo.materials[Math.floor(Math.random() * mapInfo.materials.length)];
            document.getElementById('search-result').innerHTML = `搜索到: ${randomItem}
                <button class="btn" onclick="pickItem('${randomItem}')">拾取</button>
                <button class="btn" onclick="discardItem('${randomItem}')">丢弃</button>`;
            if(Math.random() < 0.3) triggerBattle();
        }
        function pickItem(itemName) {
            // 修复3：严格判断背包容量，防止溢出
            if(playerData.backpack.length >= playerData.backpackMax) {
                document.getElementById('search-result').innerText += "\n背包已满！";
                return;
            }
            playerData.backpack.push(itemName);
            updateBackpack();
            document.getElementById('search-result').innerText = `已拾取 ${itemName}`;
        }
        function discardItem(itemName) {
            document.getElementById('search-result').innerText = `已丢弃 ${itemName}`;
        }
        function triggerBattle() {
            inBattle = true;
            const mapInfo = maps[currentMap];
            const enemyBig = Math.floor(Math.random() * (mapInfo.enemyLevel[1] - mapInfo.enemyLevel[0] + 1)) + mapInfo.enemyLevel[0];
            const enemySmall = Math.floor(Math.random() * 10) + 1;
            currentEnemy = {
                type: Math.random() > 0.5 ? "妖兽" : "散修",
                realm: { big: enemyBig, small: enemySmall },
                hp: getMaxHp(enemyBig),
                maxHp: getMaxHp(enemyBig),
                skill: skills[Math.floor(Math.random() * skills.length)]
            };
            playerTurn = playerData.speedBuff > 0 ? true : Math.random() > 0.5;
            
            document.getElementById('player-realm').innerText = `${playerData.realm.big}阶${playerData.realm.small}层`;
            document.getElementById('player-hp').innerText = playerData.hp;
            document.getElementById('player-maxhp').innerText = getMaxHp(playerData.realm.big);
            document.getElementById('enemy-type').innerText = currentEnemy.type;
            document.getElementById('enemy-realm').innerText = `${currentEnemy.realm.big}阶${currentEnemy.realm.small}层`;
            document.getElementById('enemy-hp').innerText = currentEnemy.hp;
            document.getElementById('enemy-maxhp').innerText = currentEnemy.maxHp;
            document.getElementById('battle-log').innerText = `遭遇${currentEnemy.type}！【${playerTurn ? "你" : "敌方"}先手】`;
            
            updateSkills();
            updateBattleShield(); // 战斗开始时更新护盾
            switchPanel('battle-panel');
            document.getElementById('escape-btn').disabled = false;
            document.getElementById('nav-buttons').classList.add('nav-lock');
            
            if(!playerTurn) setTimeout(enemyTurn, 1500);
        }
        // 修复核心：移除三回合后无法攻击的问题（删除buffRound对攻击的限制，不搞法力系统）
        function useSkill(skillIndex) {
            if(!inBattle || !playerTurn) return;
            const skill = playerData.skills[skillIndex];
            const playerMaxHp = getMaxHp(playerData.realm.big);
            const effectValue = skill.power * playerData.realm.big;
            
            switch(skill.type) {
                case "attack":
                    const damage = effectValue + playerData.attackBuff;
                    currentEnemy.hp = Math.max(0, currentEnemy.hp - damage);
                    document.getElementById('enemy-hp').innerText = currentEnemy.hp;
                    let log = `使用${skill.name}，造成${damage}点伤害！`;
                    if(playerData.isVampire) {
                        const vampireHp = Math.floor(damage * 0.25);
                        playerData.hp = Math.min(playerMaxHp, playerData.hp + vampireHp);
                        document.getElementById('player-hp').innerText = playerData.hp;
                        log += ` 吸血${vampireHp}点！`;
                    }
                    document.getElementById('battle-log').innerText += `\n${log}`;
                    if(currentEnemy.hp <= 0) {
                        battleWin();
                        return;
                    }
                    break;
                case "heal":
                    playerData.hp = Math.min(playerMaxHp, playerData.hp + effectValue);
                    document.getElementById('player-hp').innerText = playerData.hp;
                    document.getElementById('battle-log').innerText += `\n使用${skill.name}，恢复${effectValue}点血！`;
                    break;
                case "defense":
                    playerData.defenseBuff += effectValue;
                    playerData.buffRound = BUFF_DURATION;
                    document.getElementById('battle-log').innerText += `\n使用${skill.name}，获得${effectValue}防御，持续${BUFF_DURATION}回合！`;
                    updateBattleShield(); // 更新护盾显示
                    updateStatus();
                    updateStatusPanel();
                    break;
                case "buff":
                    playerData.attackBuff += effectValue;
                    playerData.buffRound = BUFF_DURATION;
                    document.getElementById('battle-log').innerText += `\n使用${skill.name}，获得${effectValue}攻击，持续${BUFF_DURATION}回合！`;
                    break;
                case "speed":
                    playerData.speedBuff = effectValue;
                    playerData.buffRound = BUFF_DURATION;
                    document.getElementById('battle-log').innerText += `\n使用${skill.name}，速度提升，下回合先手！`;
                    break;
                case "vampire":
                    playerData.isVampire = true;
                    playerData.buffRound = BUFF_DURATION;
                    document.getElementById('battle-log').innerText += `\n使用${skill.name}，激活25%吸血，持续${BUFF_DURATION}回合！`;
                    break;
            }
            
            // 仅处理buff过期，不影响攻击功能
            if(playerData.buffRound > 0) {
                playerData.buffRound--;
                if(playerData.buffRound <= 0) {
                    playerData.attackBuff = playerData.defenseBuff = playerData.speedBuff = 0;
                    playerData.isVampire = false;
                    document.getElementById('battle-log').innerText += "\n增益效果失效！";
                    updateBattleShield(); // 增益失效后更新护盾
                    updateStatus();
                    updateStatusPanel();
                }
            }
            
            // 强制切换回合，确保状态流转正常
            playerTurn = false;
            updateSkills();
            document.getElementById('battle-log').innerText += `\n【敌方回合】`;
            
            // 使用setTimeout确保异步执行，避免线程阻塞
            setTimeout(() => {
                enemyTurn();
            }, 1500);
        }
        function enemyTurn() {
            if(!inBattle) return;
            const enemySkill = currentEnemy.skill;
            const enemyEffect = enemySkill.power * currentEnemy.realm.big;
            const finalDamage = Math.max(0, enemyEffect - playerData.defenseBuff);
            
            switch(enemySkill.type) {
                case "attack":
                    playerData.hp = Math.max(0, playerData.hp - finalDamage);
                    document.getElementById('player-hp').innerText = playerData.hp;
                    document.getElementById('battle-log').innerText += `\n敌方使用${enemySkill.name}，造成${finalDamage}点伤害！`;
                    break;
                case "heal":
                    currentEnemy.hp = Math.min(currentEnemy.maxHp, currentEnemy.hp + enemyEffect);
                    document.getElementById('enemy-hp').innerText = currentEnemy.hp;
                    document.getElementById('battle-log').innerText += `\n敌方使用${enemySkill.name}，恢复${enemyEffect}点血！`;
                    break;
                default:
                    playerData.hp = Math.max(0, playerData.hp - finalDamage);
                    document.getElementById('player-hp').innerText = playerData.hp;
                    document.getElementById('battle-log').innerText += `\n敌方使用${enemySkill.name}，造成${finalDamage}点伤害！`;
                    break;
            }
            
            if(playerData.hp <= 0) {
                battleLose();
                return;
            }
            
            // 仅处理buff过期，不影响攻击功能
            if(playerData.buffRound > 0) {
                playerData.buffRound--;
                if(playerData.buffRound <= 0) {
                    playerData.attackBuff = playerData.defenseBuff = playerData.speedBuff = 0;
                    playerData.isVampire = false;
                    document.getElementById('battle-log').innerText += "\n增益效果失效！";
                    updateBattleShield(); // 增益失效后更新护盾
                    updateStatus();
                    updateStatusPanel();
                }
            }
            
            // 明确回合归属，确保玩家始终有攻击机会
            playerTurn = playerData.speedBuff > 0 ? true : Math.random() > 0.5;
            document.getElementById('battle-log').innerText += `\n【${playerTurn ? "你" : "敌方"}回合】`;
            updateSkills(); // 重新启用技能按钮
        }
        function battleWin() {
            const addCult = currentEnemy.realm.big * 20 + currentEnemy.realm.small * 2;
            const addMoney = currentEnemy.realm.big * 10;
            const dropItem = maps[currentMap].materials[Math.floor(Math.random() * maps[currentMap].materials.length)];
            // 修复3：拾取战利品时判断背包容量
            if(playerData.backpack.length < playerData.backpackMax) {
                playerData.backpack.push(dropItem);
            } else {
                document.getElementById('battle-log').innerText += `\n战斗胜利！获得${addCult}修为，${addMoney}灵石！（背包已满，${dropItem}已丢弃）`;
                playerData.cultivation += addCult;
                playerData.money += addMoney;
                resetBattleState();
                checkRealmUp();
                updateStatus();
                updateBackpack();
                updateStatusPanel();
                return;
            }
            playerData.cultivation += addCult;
            playerData.money += addMoney;
            
            document.getElementById('battle-log').innerText += `\n战斗胜利！获得${addCult}修为，${addMoney}灵石，${dropItem}！`;
            resetBattleState();
            checkRealmUp();
            updateStatus();
            updateBackpack();
            updateStatusPanel();
        }
        function battleLose() {
            playerData.cultivation = Math.floor(playerData.cultivation * 0.9);
            playerData.hp = getMaxHp(playerData.realm.big);
            document.getElementById('player-hp').innerText = playerData.hp;
            document.getElementById('battle-log').innerText += "\n战斗失败！损失10%修为！";
            resetBattleState();
            updateStatus();
            updateStatusPanel();
        }
        function resetBattleState() {
            inBattle = false;
            playerTurn = true;
            playerData.attackBuff = playerData.defenseBuff = playerData.speedBuff = 0;
            playerData.isVampire = false;
            playerData.buffRound = 0;
            document.getElementById('escape-btn').disabled = true;
            document.getElementById('nav-buttons').classList.remove('nav-lock');
            updateBattleShield(); // 战斗结束后重置护盾显示
            updateStatus();
            updateStatusPanel();
        }
        // 修复1：移除玩家回合限制，战斗中随时可尝试逃跑，点击必反馈
        function escapeBattle() {
            if(!inBattle) return;
            if(Math.random() < 0.5) {
                document.getElementById('battle-log').innerText += "\n成功逃跑！";
                resetBattleState();
            } else {
                document.getElementById('battle-log').innerText += "\n逃跑失败，遭到反击！";
                // 失败后触发敌人反击（无论当前是谁的回合）
                const enemySkill = currentEnemy.skill;
                const enemyEffect = enemySkill.power * currentEnemy.realm.big;
                const finalDamage = Math.max(0, enemyEffect - playerData.defenseBuff);
                playerData.hp = Math.max(0, playerData.hp - finalDamage);
                document.getElementById('player-hp').innerText = playerData.hp;
                document.getElementById('battle-log').innerText += `\n敌方使用${enemySkill.name}，造成${finalDamage}点伤害！`;
                if(playerData.hp <= 0) {
                    battleLose();
                    return;
                }
                playerTurn = playerData.speedBuff > 0 ? true : Math.random() > 0.5;
                document.getElementById('battle-log').innerText += `\n【${playerTurn ? "你" : "敌方"}回合】`;
                updateSkills();
            }
        }
        function upgradeBackpack() {
            if(playerData.money < 100) {
                alert("灵石不足100！");
                return;
            }
            playerData.money -= 100;
            playerData.backpackMax += 5;
            updateStatus();
            updateStatusPanel();
            updateBackpack();
        }
        function sellItem(index) {
            const item = playerData.backpack[index];
            playerData.money += itemValueMap[item] || 10;
            playerData.backpack.splice(index, 1);
            updateStatus();
            updateStatusPanel();
            updateBackpack();
        }
        function buySkill(skillName) {
            const skill = skills.find(s => s.name === skillName);
            if(!skill) return;
            const price = skill.level * 50;
            if(playerData.money < price) {
                alert("灵石不足！");
                return;
            }
            if(playerData.skills.some(s => s.name === skillName)) {
                alert("已学会该功法！");
                return;
            }
            playerData.money -= price;
            playerData.skills.push(skill);
            updateStatus();
            updateStatusPanel();
            updateShop();
            alert(`学会${skillName}！`);
        }
        function joinSect(sectName) {
            if(playerData.sect) {
                alert(`已加入${playerData.sect}，请先退出！`);
                return;
            }
            playerData.sect = sectName;
            document.getElementById('current-sect').innerText = `当前宗门: ${sectName}`;
            document.getElementById('sect-mission').innerText = `宗门任务：击杀${sectName}敌对妖兽10只 | 进度：0/10`;
            document.getElementById('quit-sect-btn').disabled = false;
            document.getElementById('create-sect-btn').disabled = true;
            updateStatusPanel();
        }
        function quitSect() {
            playerData.sect = "";
            document.getElementById('current-sect').innerText = "未加入宗门";
            document.getElementById('sect-mission').innerText = "";
            document.getElementById('quit-sect-btn').disabled = true;
            document.getElementById('create-sect-btn').disabled = false;
            updateStatusPanel();
        }
        function createSect() {
            const sectName = prompt("输入宗门名称：");
            if(!sectName) return;
            playerData.sect = sectName;
            document.getElementById('current-sect').innerText = `当前宗门: ${sectName}（自建）`;
            document.getElementById('sect-mission').innerText = `宗门任务：招收弟子5名 | 进度：0/5`;
            document.getElementById('quit-sect-btn').disabled = false;
            document.getElementById('create-sect-btn').disabled = true;
            updateStatusPanel();
        }
        // 新增：结识道友功能（修复无法结交道友的bug）
        function meetFriend() {
            const cost = 50; // 消耗50灵石结识道友
            if(playerData.money < cost) {
                alert("灵石不足50，无法结识道友！");
                return;
            }
            // 随机选择未结识的道友
            const availableFriends = friends.filter(friend => !playerData.friends.some(pf => pf.name === friend.name));
            if(availableFriends.length === 0) {
                alert("已结识所有道友！");
                return;
            }
            const newFriend = availableFriends[Math.floor(Math.random() * availableFriends.length)];
            playerData.money -= cost;
            playerData.friends.push(newFriend);
            alert(`成功结识道友：${newFriend.name}！`);
            updateStatus();
            updateStatusPanel();
            updateFriendList();
        }
        // 修复：双修功能（增加提示动画，修为提升90-180，无冷却限制）
        function cultivateDouble() {
            if(playerData.friends.length === 0) {
                alert("暂无道友，无法双修！");
                return;
            }
            // 随机90-180修为
            const addCult = Math.floor(Math.random() * 91) + 90;
            playerData.cultivation += addCult;
            
            // 创建双修提示动画
            const toast = document.createElement('div');
            toast.className = "double-cultivate-toast";
            toast.innerHTML = `与道友双修中...<br>感悟大道真谛！<br>获得${addCult}点修为！`;
            document.body.appendChild(toast);
            
            // 3秒后移除提示
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
            
            checkRealmUp();
            updateStatus();
            updateStatusPanel();
        }
        // 修复2：强制初始化基础攻击技能，确保进入战斗必有攻击手段
        window.onload = function() {
            switchPanel('cultivate-panel');
            loadGame(true);
            // 强制添加基础攻击技能（普攻），确保攻击功能可用
            if(!playerData.skills.some(skill => skill.type === "attack")) {
                playerData.skills.push(skills[0]);
            }
            updateStatus();
            updateBackpack();
            updateShop();
            updateFriendList();
            updateStatusPanel();
            updateBattleShield(); // 页面加载时初始化护盾显示
        };
    </script>
</body>
</html>
